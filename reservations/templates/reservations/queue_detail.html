{% extends 'website/base.html' %}
{% load check_user_group %}


{% block head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.js"></script>
{% endblock %}

{% block content %}

    <div class="section block">
        <div class="row">
            <div class="col s10 offset-s1">
                <div id='calendar'></div>
            </div>
        </div>
    </div>

    {% include 'reservations/reservation_modal.html' %}

    {% include 'reservations/require_login_modal.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            options = {
                twelveHour: false,
                i18n : {
                    cancel: 'Avbryt',
                    clear: 'Fjern',
                    done: 'Ok',
                }
            };
            var elems = document.querySelectorAll('.timepicker');
            var instances = M.Timepicker.init(elems, options);
        });

        document.addEventListener('DOMContentLoaded', function() {
            options = {
                firstDay: 1,
                i18n : {
                    cancel: 'Avbryt',
                    clear: 'Fjern',
                    done: 'Ok',
                    // months: ['Januar', 'Februar', 'Mars', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Desember'],
                    // weekdaysAbbrev: ['S', 'M', 'T', 'O', 'T', 'F', 'L'],
                }
            };
            var elems = document.querySelectorAll('.datepicker');
            var instances = M.Datepicker.init(elems, options);
        });

        $(document).ready(function () {
            $('#reservation_modal').modal({
                startingTop: '30%',
                endingTop: '50%',
            });
        });

        $(function () {

            $('#calendar').fullCalendar({

                selectable: true,
                height: 500,
                defaultView: 'agendaWeek',
                allDaySlot: false,
                firstDay: 1,
                header: {right: 'prev, next'},
                refetchResourcesOnNavigate: true,
                slotDuration: '00:30:00',
                snapDuration: '00:05:00',
                slotLabelInterval: {hours: 1},

                slotLabelFormat: "HH:mm",
                scrollTime: '10:00:00', // calendar will init scroll position to interval 10:00-18:00

                {% if request.user|has_group:"member" or request.user.is_superuser %}
                    minTime: "00:00:00",
                    maxTime: "23:59:59",
                {% else %}
                    minTime: "10:00:00",
                    maxTime: "18:00:00",
                {% endif %}

                events: {
                    url: '{% url 'reservations:reservation_api' pk=queue.pk %}',
                    type: 'GET',
                    error: function () {
                        console.log("error!");
                    },
                    success: function (data) {
                        console.log(data);
                    },
                },

                select: function (startDateTime, endDateTime) {
                    {% if request.user.is_authenticated %}
                        let modal = $('#reservation_modal')
                        let instance = M.Modal.getInstance(modal);

                        $('#id_start_date')[0].value = htmlDateFormat(startDateTime);
                        $('#id_end_date')[0].value = htmlDateFormat(endDateTime);
                        $('#id_start_time')[0].value = htmlTimeFormat(startDateTime);
                        $('#id_end_time')[0].value = htmlTimeFormat(endDateTime);
                        $('#id_parent_queue')[0].value = {{ queue.pk }};

                        instance.open();
                    {% else %}
                        let modal = $('#requireLoginModal');
                        let instance = M.Modal.getInstance(modal);
                        instance.open();
                    {% endif %}
                },

                eventMouseover: function(mouseEnterInfo){
                    console.log(mouseEnterInfo);
                }
            })


        });

        function htmlDateFormat(datetime) {
            return $.fullCalendar.formatDate(datetime, "Y-MM-DD")
        }

        function htmlTimeFormat(datetime) {
            return $.fullCalendar.formatDate(datetime, "HH:mm")
        }

        function makeReservation() {

        }
    </script>

{% endblock content %}
