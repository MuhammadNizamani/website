{% extends 'website/base.html' %}
{% load check_user_group %}


{% block head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/locale/nb.js'></script>
{% endblock %}

{% block content %}

    <div class="section block">
        <div class="row">
            <div class="col s10 offset-s1">
                <div id='calendar'></div>
            </div>
        </div>
    </div>

    {% include 'reservations/reservation_modal.html' %}

    {% include 'reservations/require_login_modal.html' %}

    {% include 'reservations/display_messages_as_toast.html' %}

    <script>
        const requestUser = '{{ request.user }}';

        let startDateField = $('#id_start_date')[0];
        let endDateField = $('#id_end_date')[0];
        let startTimeField = $('#id_start_time')[0];
        let endTimeField = $('#id_end_time')[0];
        let commentField = $('#id_comment')[0];
        let createButton = $('#createReservationInput')[0];
        let deleteButton = $('#deleteReservationButton')[0];
        let updateButton = $('#updateReservationButton')[0];
        let cancelButton = $('#cancelButton')[0];

        let selectedReservation = null;

        document.addEventListener('DOMContentLoaded', function() {
            let buttonTranslations = {cancel: 'Avbryt', clear: 'nullstill', done: 'Ok'};
            let datepickerOptions = {
                firstDay: 1,
                container: 'body', // fix for tiny picker windows: https://github.com/Dogfalo/materialize/issues/1032
                i18n: {
                    ...buttonTranslations,
                    ...{ // https://github.com/amsul/pickadate.js/blob/3.5.6/lib/translations/nb_NO.js
                        months: [ 'januar', 'februar', 'mars', 'april', 'mai', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'desember' ],
                        monthsShort: [ 'jan', 'feb', 'mar', 'apr', 'mai', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'des' ],
                        weekdaysFull: [ 'søndag', 'mandag', 'tirsdag', 'onsdag', 'torsdag', 'fredag', 'lørdag' ],
                        weekdaysShort: [ 'søn','man','tir', 'ons', 'tor', 'fre', 'lør' ],
                        today: 'i dag',
                        clear: 'nullstill',
                        close: 'lukk',
                        firstDay: 1,
                        format: 'dd. mmm. yyyy',
                        formatSubmit: 'yyyy-mm-dd'
                    }
                }
            };
            let datepickerElems = document.querySelectorAll('.datepicker');
            M.Datepicker.init(datepickerElems, datepickerOptions);

            let timepickerOptions = {
                twelveHour: false,
                i18n : buttonTranslations,
                container: 'body', // fix for tiny picker windows: https://github.com/Dogfalo/materialize/issues/1032
            };
            let timepickerElems = document.querySelectorAll('.timepicker');
            M.Timepicker.init(timepickerElems, timepickerOptions);
        });

        $(function () {

            $('#calendar').fullCalendar({

                locale: 'nb',
                selectable: true,
                height: 500,
                defaultView: 'agendaWeek',
                allDaySlot: false,
                header: {right: 'prev, next'},
                refetchResourcesOnNavigate: true,
                slotDuration: '00:30:00',
                snapDuration: '00:05:00',
                slotLabelInterval: {hours: 1},
                eventColor: '#456990',

                slotLabelFormat: "HH:mm",
                scrollTime: '10:00:00', // calendar will init scroll position to interval 10:00-18:00

                // hide hours when we are officially closed from non-members
                {% if request.user|has_group:"member" %}
                    minTime: "00:00:00",
                    maxTime: "23:59:59",
                {% else %}
                    minTime: "10:00:00",
                    maxTime: "18:00:00",
                    hiddenDays: [6, 0],
                {% endif %}

                events: {
                    url: '{% url 'reservations:reservation_api' pk=queue.pk %}',
                    type: 'GET',
                    error: function () {
                        console.log("Encountered error while retrieving reservation data!");
                    },
                    success: function (data) {
                        for (event of data) {
                            if (requestUser == event.user) {
                                event.color = '#7ABB7A';
                            }
                        }
                    },
                },

                eventClick: function(event, element) {
                    if (requestUser == event.user) {
                        selectedReservation = event;
                        let modal = $('#reservationModal');
                        setupReservationModal(event.start, event.end, true, event.comment)
                        let instance = M.Modal.getInstance(modal);
                        instance.open();
                    }
                },

                select: function (startDateTime, endDateTime) {
                    {% if request.user.is_authenticated %}
                        let modal = $('#reservationModal')
                        setupReservationModal(startDateTime, endDateTime)
                    {% else %}
                        let modal = $('#requireLoginModal');
                    {% endif %}
                        let instance = M.Modal.getInstance(modal);
                        instance.open();
                },

                eventRender: function(event, element) {
                    // Add event comments as tooltips
                    if (event.comment != "") {
                        M.Tooltip.init(element, {html: event.comment});
                    }
                    // extra tooltip to indicate that this is indeed your own reservation
                    if (event.user == requestUser) {
                        // M.Tooltip.init(element, {html: 'Din reservasjon. Klikk for å se detaljer/administrere'});
                        // element[0].M_Tooltip.tooltipEl.style = 'background-color: #7ABB7A';
                    }
                },
            })
        });

        function htmlDateFormat(datetime) {
            return $.fullCalendar.formatDate(datetime, "Y-MM-DD")
        }

        function htmlTimeFormat(datetime) {
            return $.fullCalendar.formatDate(datetime, "HH:mm")
        }

        function setupReservationModal(startDateTime, endDateTime, update=false, comment="") {
            startDateField.value = htmlDateFormat(startDateTime);
            endDateField.value = htmlDateFormat(endDateTime);
            startTimeField.value = htmlTimeFormat(startDateTime);
            endTimeField.value = htmlTimeFormat(endDateTime);
            commentField.value = comment;

            // disable all time-related fields when showing update form
            if (update) {
                commentField.oninput = function(){
                    updateButton.innerText = 'Oppdater';
                    cancelButton.style.display = 'inline';
                };

                startDateField.disabled = true;
                endDateField.disabled = true;
                startTimeField.disabled = true;
                endTimeField.disabled = true;

                updateButton.innerText = 'OK';
                cancelButton.style.display = 'none';
                updateButton.style.display = 'inline';
                createButton.style.display = 'none';
                deleteButton.style.display = 'inline';
            } else {
                commentField.oninput = function(){};

                startDateField.disabled = false;
                endDateField.disabled = false;
                startTimeField.disabled = false;
                endTimeField.disabled = false;

                updateButton.style.display = 'none';
                createButton.style.display = 'inline';
                deleteButton.style.display = 'none';
            }
        }

        deleteButton.onclick = function() {
            $.ajax({
                url: '{% url 'reservations:reservation_delete_api' pk=1%}'.slice(0, -2) + selectedReservation.id + '/',
                data: {},
                type: 'POST',
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function() {
                    $('#calendar').fullCalendar('refetchEvents');
                    M.toast({html: 'Reservasjon slettet!'})
                },
                error: function() {
                    alert("Noe gikk galt, vennligst prøv igjen.");
                },
            })
        }

        updateButton.onclick = function() {
            $.ajax({
                url: '{% url 'reservations:reservation_update_api' pk=1%}'.slice(0, -2) + selectedReservation.id + '/',
                data: {comment: $('#id_comment')[0].value},
                type: 'POST',
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function() {
                    $('#calendar').fullCalendar('refetchEvents');
                    M.toast({html: 'Reservasjon oppdatert!'})
                },
                error: function() {
                    alert("Noe gikk galt, vennligst prøv igjen.");
                },
            })
        }
    </script>

{% endblock content %}
