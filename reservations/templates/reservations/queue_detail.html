{% extends 'website/base.html' %}
{% load staticfiles %}
{% block head %}

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script type="text/javascript" src="{% static "reservations/fullcalendar/moment/moment.js" %}"></script>
<link rel="stylesheet" href="{% static "reservations/fullcalendar/core/main.min.css" %}">
<link rel="stylesheet" href="{% static "reservations/fullcalendar/daygrid/main.min.css" %}">
<link rel="stylesheet" href="{% static "reservations/fullcalendar/timegrid/main.min.css" %}">
<script type="text/javascript" src="{% static "reservations/fullcalendar/core/main.min.js" %}"></script>
<script type="text/javascript" src="{% static "reservations/fullcalendar/moment/main.min.js" %}"></script>
<script type="text/javascript" src="{% static "reservations/fullcalendar/interaction/main.min.js" %}"></script>
<script type="text/javascript" src="{% static "reservations/fullcalendar/daygrid/main.min.js" %}"></script>
<script type="text/javascript" src="{% static "reservations/fullcalendar/timegrid/main.min.js" %}"></script>
<script src="{% static "reservations/fullcalendar/core/locales/nb.js" %}"></script>
<style type='text/css'>
    .fc h2 {
	    font-size: 2.28rem;
	    line-height: 110%;
    }

    .fc-time-grid .fc-slats td {
	    height: 2.5em;
	    border-bottom: 0;
    }
    </style>
{% endblock %}

{% block content %}
<div class="section hs-green">
	<div class="container">
		<div class="row white-text">
			<div class="col s12">
				<h4>{{ object.name }}</h4>
				<p>På denne siden kan du reservere bruk av {{ object.name }}.</p>
			</div>
		</div>
	</div>
</div>
<div class="section">
	<div class="container">
		{% if not perms.reservations.view_user_details and disable_reservations %}
		<div class="row">
			<div class="col s12">
				<p>Hackerspace er i en tidsramme hvor reservasjonssystemet er stengt. Dette er som regel eksamenstid, ferie, etc.</p>
				<p>Dersom du er medlem i Hackerspace, logg på din konto for å kunne reservere print utenom vanlige åpningstider.</p>
			</div>
		</div>
		{% else %}
		<div class="row">
			<div class="col s6">
				<div class="card-panel small hs-green white-text z-depth-0">
					<p>Grønne blokker er dine egne reservasjoner.</p>
					<p>Trykk en av dine reservasjoner for å oppdatere kommentaren eller slette den.</p>
				</div>
			</div>
			<div class="col s6">
				<div class="card-panel small hs-gray white-text z-depth-0">
					<p>Grå blokker er andre sine reservasjoner.</p>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col s12">
				<div id='calendar'></div>
			</div>
		</div>
		{% endif %}
	</div>
</div>

{% include 'reservations/reservation_modal.html' %}

<script>
	const requestUser = '{{ request.user.id }}';
	const pk = '{{ object.id }}';

	let newStartField = document.getElementById('id_start');
	let newEndField = document.getElementById('id_end');
	let newCommentField = document.getElementById('id_comment');
	let exStartField = document.getElementById('ex_start');
	let exEndField = document.getElementById('ex_end');
	let exCommentField = document.getElementById('ex_comment');
	let exIdField = document.getElementById('ex_id');
	let selectedEvent = Object;
	let createButton = document.getElementById('createButton');
	let deleteButton = document.getElementById('deleteButton');
	let updateButton = document.getElementById('updateButton');
	let cancelButton = document.getElementById('cancelButton');

	let selectedReservation = null;

	document.addEventListener('DOMContentLoaded', function() {

		var calendarEl = document.getElementById('calendar');

		var calendar = new FullCalendar.Calendar(calendarEl, {
			locale: 'nb',
			plugins: ['moment', 'interaction', 'timeGrid'],
			defaultView: 'timeGridWeek',
			selectable: true,
			selectMirror: true,
			selectAllow: function(info) {
				return moment().diff(info.start) <= 0
			},
			height:"auto",
			allDaySlot: false,
			slotDuration: '00:30:00',
			snapDuration: '00:10:00',
			slotLabelInterval: {hours: 0.5},
			selectOverlap: false,
			{% if perms.reservations.view_user_details %}
			minTime: "00:00:00",
			maxTime: "23:59:59",
			weekends: true,
			{% else %}
			minTime: "10:00:00",
			maxTime: "18:00:00",
			weekends: false,
			{% endif %}
			eventClick: function(eventClickInfo) {
				console.log(eventClickInfo);
				{% if not request.user.is_superuser %}
				if (requestUser == eventClickInfo.event.extendedProps.user) {
					let modal = document.getElementById("updateModal");
					exStartField.value = DateTimeFormat(eventClickInfo.event.start);
					exEndField.value = DateTimeFormat(eventClickInfo.event.end);
					exCommentField.value = eventClickInfo.event.extendedProps.comment;
					exIdField.value = eventClickInfo.event.id;
					let instance = M.Modal.getInstance(modal);
					instance.open();
					M.updateTextFields();
				}
				{% else %}
					let modal = document.getElementById("updateModal");
					exStartField.value = DateTimeFormat(eventClickInfo.event.start);
					exEndField.value = DateTimeFormat(eventClickInfo.end);
					exCommentField.value = eventClickInfo.event.comment;
					exIdField.value = eventClickInfo.event.id;
					let instance = M.Modal.getInstance(modal);
					instance.open();
					M.updateTextFields();
				{% endif %}
			},
			select: function (selectionInfo) {
				{% if request.user.is_authenticated %}
					{% if not request.user.profile.phone_number %}
					{# Hvis bruker ikke har lagt inn telefonnummer #}
				let modal = document.getElementById("phoneNumberModal");
				let instance = M.Modal.getInstance(modal);
				instance.open();
				M.updateTextFields();
				{% else %}
				let modal = document.getElementById("reservationModal");
				newStartField.value = DateTimeFormat(selectionInfo.start);
				newEndField.value = DateTimeFormat(selectionInfo.end);
				newCommentField.value = "";
				let instance = M.Modal.getInstance(modal);
				instance.open();
				M.updateTextFields();
				{% endif %}
				{% else %}
				M.toast({'html': 'Du må være logget inn for å opprette reservasjoner.'})
				{% endif %}
			},
			events: {
				url: '/api/reservations/',
				method: 'GET',
				extraParams: {
					parent_queue: {{ queue.pk }}, },
				failure: function() {
					alert('there was an error while fetching events!');
				},
				color: '#4E4B46',
				textColor: '#FFF',
			},
			eventRender: function(info) {
				console.log(info);
				var elem = info.el
				elem.setAttribute("style", 'font-size: 1rem;');
				// Add event owner and comment as tooltip for members
				if (requestUser == info.event.extendedProps.user) {
					elem.setAttribute("style", "background-color: #5BBA47;");
					M.Tooltip.init(info.el, {html: "Trykk for å redigere" });
				} else {
					elem.setAttribute("style", "background-color: #4E4B46;");
				}
				{% if perms.reservation.view_reservation_user_details %}
				{# kun dersom en bruker har rettigheter til å se navn og nummer #}
					elem.append(info.event.extendedProps.fullname + "\n");
					
					elem.append(info.event.extendedProps.phone);
				{% endif %}
			}
		});

		calendar.render();

		createButton.addEventListener('click', function() {
			data = {
				comment: $('#id_comment')[0].value,
				start: $('#id_start')[0].value,
				end: $('#id_end')[0].value,
				parent_queue: {{ queue.id }},
				user: {{ request.user.pk }}
			}

			$.ajax({
				url: '/api/reservations/',
				data: data,
				type: 'POST',
				beforeSend: function (xhr, settings) {
					xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
				},
				success: function() {
					calendar.refetchEvents();
					M.toast({html: "Reservasjonen var vellykket."})
				},
				error: function(e) {
					calendar.refetchEvents();
					for (var error in e.responseJSON.non_field_errors) {
						if (e.responseJSON.non_field_errors.hasOwnProperty(error)) {
							M.toast({html: e.responseJSON.non_field_errors[error]})
						}
					}
				},
			});
		});
		deleteButton.addEventListener('click', function() {
			$.ajax({
				url: '/api/reservations/' + $('#ex_id')[0].value + "/",
				type: 'DELETE',
				beforeSend: function (xhr, settings) {
					xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
				},
				success: function(response) {
					calendar.refetchEvents();
					M.toast({html: "Reservasjonen er slettet."})
				},
				error: function(e) {
					calendar.refetchEvents();
					for (var error in e.responseJSON.non_field_errors) {
						if (e.responseJSON.non_field_errors.hasOwnProperty(error)) {
							M.toast({html: e.responseJSON.non_field_errors[error]})
						}
					}
				},
			});
		});

		updateButton.addEventListener('click', function() {
			data = {
				comment: $('#ex_comment')[0].value,
			}
			$.ajax({
				url: '/api/reservations/' + $('#ex_id')[0].value + "/",
				data: data,
				type: 'PATCH',
				beforeSend: function (xhr, settings) {
					xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
				},
				success: function(response) {
					calendar.refetchEvents();
					M.toast({html: "Kommentaren er oppdatert."})
				},
				error: function(e) {
					calendar.refetchEvents();
					for (var error in e.responseJSON.non_field_errors) {
						if (e.responseJSON.non_field_errors.hasOwnProperty(error)) {
							M.toast({html: e.responseJSON.non_field_errors[error]})
						}
					}
				},
			});


		});
	});

	function DateTimeFormat(datetime) {
		return moment(datetime).format('YYYY-MM-DDTHH:mm:ss');
	}


</script>

{% endblock content %}
