{% regroup images by tags as tag_groups %}

{% load static %}
{% block header %}
<link rel="stylesheet" type="text/css" href="{% static 'files/css/modal.css' %}">
{% endblock %}

<a class="modal-trigger waves-effect hs-green white-text waves-light btn btn-large col s12" data-target="thumbnailPicker">Vis bildegalleri</a>

<div id="thumbnailPicker" class="modal">
	<div class="modal-content gallery-content">
		<div class="gallery-header hs-gray">
			<h4 class="white-text">Velg bilde</h4>
			<div class="row">
				<a class="col s12 l5 btn hs-green btn-small white-text modal-trigger" href="#uploadModal" target="_blank">Last opp nytt bilde</a>
				<div class="col s12 hide-on-large-only">
					<div class="invisible-divider-large"></div>
				</div>
				<a class="col s12 l5 push-l2 btn hs-yellow btn-small hs-gray-text" href="/files/images" target="_blank">Administrer bilder</a>
			</div>
		</div>

		<div class="row tag-galleries">
			{% for tag in tag_groups %}
				<div class="col s12">
					<div class="row">
						<div class="col s12 hs-green white-text">
							<h4 class="category-header">{{ tag.grouper }}</h4>
						</div>
						<div class="gallery tag-{{ tag.grouper }}">
							{% for image in tag.list %}
							{% include 'files/single-image.html' %}
							{% endfor %}
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
	</div>
</div>

<div class="modal" id="uploadModal">
	<div class="modal-content">
		<h4>Last opp nytt bilde til galleriet</h4>
		{% csrf_token %}
		<div class="input-field col s12">
			{{ UploadForm.title }}
			<label for="{{ UploadForm.title.id_for_label }}">{{ UploadForm.title.label }}</label>
		</div>
		<div class="input-field col s12">
			{{ UploadForm.description }}
			<label for="{{ UploadForm.description.id_for_label }}">{{ UploadForm.description.label }}</label>
		</div>
		<div class="input-field col s12">
			{{ UploadForm.tags }}
			<label for="{{ UploadForm.tags.id_for_label }}">{{ UploadForm.tags.label }}</label>
		</div>
		<div class="file-field input-field col s12">
			<div class="btn btn-flat white-text hs-green">
				<span>Velg bilde</span>
				{{ UploadForm.file }}
			</div>
			<div class="file-path-wrapper">
				<input id="{{ UploadForm.file.id_for_label }}-path" class="file-path validate" type="text">
			</div>
		</div>
		<a href="#" class="btn btn-flat btn-large hs-green white-text" id="uploadBtn">Last opp bilde til galleri</a>
	</div>
</div>

<script>
var thumbModal = document.querySelector('#thumbnailPicker');
var uploadModal = document.querySelector('#uploadModal');
var submitBtn = document.getElementById('uploadBtn');

submitBtn.addEventListener('click', function(e)Â {
	e.preventDefault();

	// Grab all the form data
	var title_field = document.getElementById('id_img-title');
	var desc_field = document.getElementById('id_img-description');
	var tag_field = document.getElementById('id_img-tags');
	var img_field = document.getElementById('id_img-file');
	var img_field_path = document.getElementById('id_img-file-path');

	var formdata = new FormData();
	formdata.append("img-file", img_field.files[0]);
	formdata.append("img-title", title_field.value);
	formdata.append('img-tags', tag_field.value);
	formdata.append("img-description", desc_field.value);

	// Upload the image
	var csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
	$.ajax({
		type:'POST',
		url: "/files/image-upload/",
		headers: {
			'X-CSRFToken': csrftoken 
		},
		data: formdata,
		contentType: false,
		processData: false,
		success: function(response){
			// Add the uploaded image to the gallery immediately
			const gallery = $('.tag-' + tag_field.value);
			if (!gallery || !gallery.length)
			{
				// New tag/category, so we need to make a new gallery for it
				const galleries = $('.tag-galleries');

				const column = $('<div>', {'class': 'col s12'});
				const gallery_row = $('<div>', {'class': 'row'});
				const gallery_header = $('<div>', {'class': 'col s12 hs-green white-text'});
				const gallery_title = $('<h4>', {'class': 'category-header'});
				gallery_title.append(tag_field.value);

				const tag_gallery = $('<div>', {'class': 'gallery tag-' + tag_field.value});
				tag_gallery.prepend(response);

				gallery_header.append(gallery_title);
				gallery_row.append(gallery_header);
				gallery_row.append(tag_gallery);
				column.append(gallery_row);
				galleries.append(column);
			}
			else
			{
				gallery.prepend(response);
			}

			M.toast( { html: 'Bildet er lastet opp og kan velges fra galleriet' });
			M.Modal.getInstance(uploadModal).close();

			// Clear the form
			title_field.value = '';
			desc_field.value = '';
			tag_field.value = 'Usortert';
			img_field_path.value = '';
			img_field.value = null;
		},
		error: function(response) {
			M.toast( { html: 'Noe gikk galt under bildeopplastningen' });
			console.log(response);
		}
	});
});
</script>
