{% extends 'website/base.html' %}
{% load staticfiles %}
{% load cards %}
{% load utils %}
{% load divtags %}
{% load picker_modal %}
{% load register %}
{% block head %}
{% endblock %}
{% block content %}
<div id="app">
	<!-- TODO: Fikse modals og for loop til avatarmenyen -->
	<!-- Green overhead menu -->
	<div class="section hs-green white-text">
		<div class="container">
			<div class="row">
				<div class="col s12 white-text">
					<h4>Inventar</h4>
				</div>
			</div>
		</div>
	</div>
	{% if perms.inventory %}
	<div class="section white">
		<div class="container">
			<!-- Start admin menu-->
			<div class="row">
				<div class="col s12">
					<div class="card">
						<div class="card-content">
							<span class="card-title">Administrator meny</span>
						</div>
						<div class="card-action white-text">
							<!-- Modal Triggers -->
							{% if perms.inventory.add_item %}
							<a href="#add_item" class="btn modal-trigger">Legg til gjenstand</a>
							{% endif %}
							<div id="reg_item">
								{{ msg }}
							</div>
							{% if perms.inventory.add_tag %}
							<a href="#add_tag" class="btn modal-trigger">Legg til tag</a>
							{% endif %}
							{% if perms.inventory.add_loan %}
							<a href="#reg_loan" class="btn modal-trigger">Registrer utlån</a>
							<a href="#adm_loan" class="btn modal-trigger">Administrerutlån</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Modals -->
		<div id="add_item" class="modal">
			<div class="modal-content">
				<p>Add item</p>
				<form method="post">
					{% csrf_token %}
					{% for field in itemform %}
					{% if field.label == "Thumbnail" %}
					<div class="input-field hidden">
						<input class="thumbnailPicker hidden" id="{{ field.id_for_label }}" name="thumbnail" type="hidden" value="{{ field.value }}">
					</div>
					<i class="material-icons prefix">photo_library</i>
					<label for="thumb-preview">Thumbnail</label>
					<div id="thumb-preview" class="card small thumb-preview modal-trigger" data-target="thumbnailPicker" style="background-image: url(/files/image/{{ field.value }}/view);"></div>
					{% else %}
					<div class="input-field col s12">
						{{ field }}
						<label for="{{ field.id_from_label }}">{{ field.label }}</label>
					</div>
					{% endif %}
					{% endfor %}
					<input type="submit" name="item"/>
				</form>
			</div>
		</div>
		<div id="thumbnailPicker" class="modal">
			<div class="modal-content">
				{% ImageModal request %}
			</div>
		</div>
		<div id="add_tag" class="modal">
			<div class="modal-content">
				<p>Add tag</p>
				<form method="POST">
					{% csrf_token %}
					{% for field in tagform %}
					<div class="input-field col s12">
						{{ field }}
						<label for="{{ field.id_from_label }}">{{ field.label }}</label>
					</div>
					{% endfor %}
					<input type="submit" name="tag" class="btn btn-large">Submit </input>
				</form>
			</div>
		</div>
		<div id="reg_loan" class="modal">
			<div class="modal-content">
				{{ ItemForm }}
			</div>
		</div>
		<div id="edit_modal" class="modal">
			<div class="modal-content">
				{% csrf_token %}
				<div v-for="(item, key) in current_item" :key="key" v-model="item" class="input-field col s12">
					<select v-if="key == 'tags'" multiple class="browser-default">
						<option value="" disabled selected>Choose your option</option>
						<option v-for="tag in item" :value="tag.id">[[ tag.name ]]</option>
					</select>
					<label v-if="key == 'tags'">LAbel</label>

					<input type="text" :id="key" :value="item">
					<label class="active" :for="key">[[ key ]]</label>
				</div>
				<input type="submit" name="tag" class="btn btn-large">Submit </input>
				</form>

			</div>
		</div>
		<div id="adm_loan" class="modal">
			<!-- add modal from administrate_loan.html -->
		</div>
		<div class="divider"></div>
	</div>
	<!-- End admin menu-->
	{% endif %}
	<div class="section white">
		<div class="container">
			<!-- start main content -->
			<div class="row">
				{% if perms.inventory %}
				<div class="col s6">
					<a href="{% url 'inventory:my_loans' %}"  class="btn">Mine lån</a>
				</div>
				{% endif %}
				<!-- TODO: knytte søkefelt til items -->
				<div class="col s6">
					<input type="text" name="search" placeholder="Søk">
				</div>
			</div>
			<div class="row">
				<!-- Rabperry Pi category skeleton-->
				<div class="col s12">
					<ul class="collapsible">
						<li v-for="tag in tags">
							<div class="collapsible-header">
								<span> [[ tag.name ]] </span>
							</div>
							<div class="collapsible-body" >
								<ul class="collection">
									<li v-for="item in tag.item_set" :key="item.id" class="collection-item avatar">
										<img src="[[ item.thumbnail.file ]]" />
										<a class="modal-trigger" v-on:click="getItem(item.id)" href="#edit_modal">
											<span> [[ item.name ]] </span>
										</a>
									</li>
								</ul>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	new Vue({
		el: "#app",
		delimiters: ["[[","]]"],
		data: {
			tags: [],
			current_item: [],
		},
		mounted: function() {
			this.getTags();
		},
		methods: {
			getTags: function() {
				this.$http.get('/inventory/tags').then((response => {
					this.tags = response.data;
					console.log(response.data);
				}));
				console.log(this.tags);
			},
			getItem: function(id) {
				this.$http.get('/inventory/items/' + id).then((response => {
					this.current_item = response.data;
					console.log(response.data);
				}));
			},
		}
	});
	M.AutoInit();
	var elem = document.querySelector('#tags');
	var instance = M.FormSelect.init(elem);
</script>

{% endblock content %}
