{% extends 'base.html' %}
{% load staticfiles %}
{% load cards %}
{% load utils %}
{% load divtags %}

{% block header %}
    <link rel="stylesheet" type="text/css" href="{% static "inventory/css/style.css" %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="{% static 'inventory/js/index.js' %}"></script>
{% endblock header %}


{% block content %}
    <!-- For å vise eventuelle meldinger fra oppretting/endring av item eller tag. -->
    {% if messages %}
        {% for message in messages %}
            <script>
                var $toastContent = $('<span>{{ message }}</span>');
                Materialize.toast($toastContent, 5000);
                <!-- TODO sette delay på disse hvis man har flere meldinger-->
            </script>
        {% endfor %}
    {% endif %}

    <div class="content">
        <br>
        <form id="searchform" action="{% url 'inventory:search' %}" method="get">
            {% csrf_token %}
            <input class="searchfield" id="searchbox" name="q" type="text" placeholder="Søk" autocomplete="off">
            <button class="btn waves-effect waves-light" type="submit" name="action">søk</button>
        </form>

        <h1>Inventar</h1>

        {% if request.user.is_authenticated %}
            {% if perms.inventory.add_item %}
                <a href="{% url 'inventory:add_item' %}" class="waves-effect waves-light btn">Legg til gjenstand</a>
            {% endif %}
            {% if perms.inventory.add_tag %}
                <a href="{% url 'inventory:add_tag' %}" class="waves-effect waves-light btn">Legg til tag</a>
            {% endif %}
            {% if perms.inventory.add_loan %}
                <a href="{% url 'inventory:register_loan' %}" class="waves-effect waves-light btn">Registrer utlån</a>
                <a href="{% url 'inventory:administrate_loans' %}" class="waves-effect waves-light btn">Administrer
                    utlån</a>
            {% endif %}
            <a href="{% url 'inventory:my_loans' %}" class="waves-effect waves-light btn">Mine lån</a>
        {% endif %}


        <!-- TODO knapper man ikke kan bruke med mindre man er logget inn, kan enten linke til innloggingsside, eller
        være gråe, og ikke fungerende
        TODO endre fra "category" til "tag", for å være konsekvent
        TODO endre dette når man får maaange tags.
        TODO endre så kun brukere med endringstilgang kan se de som er slettet.
        -->

        <div class="row">
            <div class="col s3">
                <div class="card horizontal" style="background-color: var(--hs-gray-li3);">
                    <div class="card-stacked">
                        <div class="card-content">
                            <p>Velg tagger du vil vise</p>
                        </div>
                        <form id="check-form" action="{% url 'inventory:index' %}" method="post"
                              style="padding-left: 15px;">
                            {% csrf_token %}

                            <!-- TODO printe ut alle tags som ligger under denne, kan implementeres senere. -->
                            <!-- TODO kan printe rekursivt ved hjelp av en templatetag -->

                            <!-- recursive template tag -->
                            {% tag_hierarchy tags 0 20 %}
                            <br>

                            <label for="check_json"></label>
                            <input type="text" name="check_json" id="check_json" hidden="hidden">

                        </form>

                        <div class="card-action">
                            <button class="btn waves-effect waves-light" type="button"
                                    onclick="postCheckBoxes()">Refresh!
                            </button>

                        </div>
                    </div>
                </div>
            </div>

            <div class="col s9">
                {% for item in items %}
                    <div class="card horizontal item-card" style="background: var(--hs-gray-li2)"
                         id="item-{{ item.id }}"
                         about="{{ item|get_tags|safe }}">

                        <div class="card-stacked">
                            <div class="card-content">
                                <span class="card-title"><a
                                        href="{% url 'inventory:detail' item.id %}">{{ item.name }} {{ item.id }}</a></span>
                                <br>
                                {% if item.tags %}
                                    {% for tag in item.tags.all %}
                                        <div class="chip">
                                            <a href="{% url 'inventory:tag_detail' tag.id %}">{{ tag.name }}</a>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                <br>
                                <p>{{ item.description }}</p>
                                <br>
                                <p>Antall: {{ item.quantity }}</p>
                                <br>

                            </div>
                        </div>
                    </div>
                {% endfor %}

            </div>


        </div>

        <script>
            // TODO bør sette boksene tilbake dit de var før man poster.
            var postedTags = {{ posted_tags|safe }};

            $(function () {
                showBoxes(postedTags);
            });

            function showBoxes(postedTags) {
                // Viser og checker av bokser som var checked før man poster.
                for (var key in postedTags) {
                    $('#' + key).attr('checked', true);
                    $('.child-of-' + key).show();
                    if (Object.keys(postedTags[key]).length > 0) {
                        showBoxes(postedTags[key]);
                    }
                }
            }
        </script>

    </div>
{% endblock content %}
