{% extends 'website/base.html' %}
{% load staticfiles %}
{% load picker_modal %}
{% load rest_framework %}
{% block content %}
<div id="app">
	<!-- TODO: Fikse modals og for loop til avatarmenyen -->
	<!-- Green overhead menu -->
	<div class="section hs-green white-text">
		<div class="container">
			<div class="row">
				<div class="col s12 white-text">
					<h4>Inventar</h4>
				</div>
			</div>
		</div>
	</div>
	{% if perms.inventory %}
	<div class="section white">
		<div class="container">
			<!-- Start admin menu-->
			<div class="row">
				<div class="col s12">
					<div class="card">
						<div class="card-content">
							<span class="card-title">Administrator meny</span>
						</div>
						<div class="card-action white-text">
							<!-- Modal Triggers -->
							{% if perms.inventory.add_item %}
								<a class="modal-trigger" v-on:click="setItem(new_item, true)" href="#edit_modal">Legg til gjenstand</a>
							{% endif %}
							{% if perms.inventory.add_tag %}
								<a class="modal-trigger" href="#add_tag" v-on:click="updateTags()" class="btn modal-trigger">Legg til tag</a>
							{% endif %}
							{% if perms.inventory.add_loan %}
							<a href="#reg_loan" class="btn modal-trigger">Registrer utlån</a>
							<a href="#adm_loan" class="btn modal-trigger">Administrerutlån</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Modals -->
		<div id="thumbnailPicker" class="modal">
			<div class="modal-content">
				{% ImageModal request %}
			</div>
		</div>
		<div id="add_tag" class="modal">
			<div class="modal-content">
				<p>Add tag asd</p>
				<div class="input-field col s12">
					<input id="name" v-model="new_tag.name"/>
					<label for="name" class="active">Navn</label>
				</div>
				<div class="input-field col s12">
					<input id="visible" v-model="new_tag.visible"/>
					<label for="visible" class="active">Beskrivelse</label>
				</div>
				<a href="#!" class="btn btn-large" v-on:click="postTag(new_tag)">Legg til</a>
			</div>
		</div>
		<div id="loan_modal" class="modal">
			<div class="modal-content">
				<div class="input-field col s12">
					<input id="name" v-model="new_loan.borrower"/>
					<label for="name" class="active">Navn</label>
				</div>
				<div class="input-field col s12">
					<input id="name" v-model="new_loan.lender"/>
					<label for="name" class="active">Utleier</label>
				</div>
				<div class="input-field col s12">
					<input id="email" v-model="new_loan.email"/>
					<label for="email" class="active">Epost-addresse</label>
				</div>
				<div class="input-field col s12">
					<input id="quantity" v-model="new_loan.quantity"/>
					<label for="quantity" class="active">Antall enheter å låne ut</label>
				</div>
				<div class="input-field col s12">
					<input id="phone" v-model="new_loan.phone"/>
					<label for="phone" class="active">Telefonnummer</label>
				</div>
				<div class="input-field col s12">
					<input id="comment" v-model="new_loan.comment"/>
					<label for="comment" class="active">Kommentar</label>
				</div>
				<a href="#!" class="btn btn-large" v-on:click="postLoan(new_loan)">Legg til</a>
			</div>
		</div>
		<div id="edit_modal" class="modal">
			<div class="modal-content">
			<div class="row">
				<div class="input-field col s12">
					<input id="name" v-model="current_item.name"/>
					<label for="name" class="active">Navn</label>
				</div>
				<div class="input-field col s12">
					<input id="description" v-model="current_item.description"/>
					<label for="description" class="active">Beskrivelse</label>
				</div>
				<div class="input-field col s12">
					<input id="quantity" v-model="current_item.quantity"/>
					<label for="quantity" class="active">Kvantitet</label>
				</div>
				<div class="input-field col s12">
					<input id="thumbnail" v-model="current_item.thumbnail"/>
					<label for="thumbnail" class="active">Bilde</label>
				</div>
				<div class="input-field col s12">
					<select id="tagSelector" v-model="current_item.tags" v-if="current_item.tags" multiple>
						<option value="" disabled>Velg ny kategori</option>
						<option v-for="tag in tagList" v-bind:value="tag.id"> [[ tag.name ]]</option>
					</select>
				</div>
				<div class="input-field col s12">
					<input id="zone" v-model="current_item.zone"/>
					<label for="zone" class="active">Sone</label>
				</div>
				<div class="input-field col s12">
					<input id="shelf" v-model="current_item.shelf"/>
					<label for="shelf" class="active">Hylleplass</label>
				</div>
				<div class="input-field col s12">
					<input id="column" v-model="current_item.column"/>
					<label for="column" class="active">Kolonne</label>
				</div>
				<div class="input-field col s12">
					<a href="#!" v-if="add" class="btn btn-large" v-on:click="postItem(current_item)">Legg til</a>
					<a href="#!" v-if="!add" class="btn btn-large" v-on:click="putItem(current_item)">Oppdater</a>
				</div>
			</div>
			</div>
		</div>
		<div id="adm_loan" class="modal">
			<!-- add modal from administrate_loan.html -->
		</div>
		<div class="divider"></div>
	</div>
	<!-- End admin menu-->
	{% endif %}
	<div class="section white">
		<div class="container">
			<!-- start main content -->
			<div class="row">
				{% if perms.inventory %}
				<div class="col s6">
				</div>
				{% endif %}
				<!-- TODO: knytte søkefelt til items -->
				<div class="col s6">
					<input type="text" name="search" placeholder="Søk">
				</div>
			</div>
			<div class="row">
				<!-- Rabperry Pi category skeleton-->
				<div class="col s12">
					<ul class="collapsible">
						<li v-for="tag in tagList" :key="tag.id">
							<div class="collapsible-header">
								<span> [[ tag.name ]] </span>
							</div>
							<div class="collapsible-body" >
								<ul class="collection">
									<li v-for="item in tag.item_set" class="collection-item avatar">
										<img v-if="item.thumbnail" :src="item.thumbnail.file" alt="" class="circle">
										<a class="modal-trigger" v-on:click="setItem(item, false)" href="#edit_modal">
											<span class="title"> [[ item.name ]] </span>
										</a>
										<p>[[ item.description ]]<br>
										[[ item.quantity_left ]]/[[ item.quantity ]], sone [[ item.zone ]], [[ item.shelf ]] [[ item.row ]] [[ item.column ]].
										</p>
										<a v-if="item.quantity_left <= 0" v-on:click="setItem(item, false)" href="#loan_modal" class="modal-trigger secondary-content btn btn-small hs-green white-text disabled"><i class="material-icons">arrow_forward</i>Lån ut</a>
										<a v-else v-on:click="setItem(item, false)" href="#loan_modal" class="modal-trigger secondary-content btn btn-small hs-green white-text"><i class="material-icons">arrow_forward</i>Lån ut</a>
									</li>
								</ul>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>}
<script type="text/javascript">
	function readCookie(name) {
		var nameEQ = name + "=";
		var ca = document.cookie.split(';');
		for(var i=0;i < ca.length;i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') c = c.substring(1,c.length);
			if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
		}
		return null;
	}
	new Vue({
		el: "#app",
		delimiters: ["[[","]]"],
		data: {
			tagList: [],
			add: false,
			current_item: "",
			new_item: { "id": null, "name": null, "description": null, "quantity": null, "thumbnail": null, "tags": [], "zone": null, "shelf": null, "row": null, "column": null },
			new_tag: { "id": null, "name": null, "parent_tag": null, "item_set": [], },
			new_loan: { "borrower": null, "lender": null, "comment": "none", "email": null, "phone": null, "item": null },
		},
		mounted: function() {
			this.getTagList();
		},
		methods: {
			getTagList: function() {
				this.$http.get('/inventory/tags').then(
				function (response) {
					this.tagList = response.data;
				},
				function(response) {
					M.toast({html: "Noe gikk galt under henting av tags. Feilkode: " + response.detail});
				});
			},
			setItem: function(item, add) {
				this.add = add;
				this.current_item = item;
				this.current_item.tags = item.tags;
				Vue.nextTick(function () {
					var selectorElement = document.querySelector('#tagSelector');
					var instance = M.FormSelect.init(selectorElement);
				})
			},
			updateTags: function(item, add) {
				Vue.nextTick(function () {
					var selectorElement = document.querySelector('#tagSelector');
					var instance = M.FormSelect.init(selectorElement);
				})
			},
			putItem: function(current_item) {
				this.$http.put('/inventory/items/' + current_item.id, current_item).then((response => {
					M.toast({html: response.statusText});
				}));
				this.getTagList();
			},
			postItem: function(current_item) {
				this.$http.post('/inventory/items/', current_item).then((response => {
					M.toast({html: response.statusText});
				}));
				this.getTagList();
			},
			postTag: function(tag) {
				this.$http.post('/inventory/tags/', tag).then((response => {
					M.toast({html: response.statusText});
				}));
				this.getTagList();
			},
			postLoan: function(loan) {
				loan.item = this.current_item.id;
				loan.item.visible = false;
				this.$http.post('/inventory/loans/', loan).then((response => {
					M.toast({html: response.statusText});
				}));
				this.getTagList();
			},
		}
	});
	var csrftoken = readCookie('csrftoken');
	Vue.http.headers.common['X-CSRFTOKEN'] = csrftoken;
	M.AutoInit();
	
</script>

{% endblock content %}
