{% extends 'website/base.html' %}
{% load staticfiles %}
{% load picker_modal %}
{% load rest_framework %}
{% block content %}
<div id="app">
	<!-- TODO: Fikse modals og for loop til avatarmenyen -->
	<!-- Green overhead menu -->
	<div class="section hs-green white-text">
		<div class="container">
			<div class="row">
				<div class="col s12 white-text">
					<h4>Inventar</h4>
				</div>
			</div>
		</div>
	</div>
	{% if perms.inventory %}
	<div class="section white">
		<div class="container">
			<!-- Start admin menu-->
			<div class="row">
				<div class="col s12">
					<div class="card">
						<div class="card-content">
							<span class="card-title">Administrator meny</span>
						</div>
						<div class="card-action white-text">
							<!-- Modal Triggers -->
							{% if perms.inventory.add_item %}
							<a class="modal-trigger" v-on:click="getItem()" href="#edit_modal">Legg til gjenstand</a>
							{% endif %}
							<div id="reg_item">
								{{ msg }}
							</div>
							{% if perms.inventory.add_tag %}
							<a href="#add_tag" class="btn modal-trigger">Legg til tag</a>
							{% endif %}
							{% if perms.inventory.add_loan %}
							<a href="#reg_loan" class="btn modal-trigger">Registrer utlån</a>
							<a href="#adm_loan" class="btn modal-trigger">Administrerutlån</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Modals -->
		<div id="add_item" class="modal">
			<div class="modal-content">
				<p>Add item</p>
			</div>
		</div>
		<div id="thumbnailPicker" class="modal">
			<div class="modal-content">
				{% ImageModal request %}
			</div>
		</div>
		<div id="add_tag" class="modal">
			<div class="modal-content">
				<p>Add tag</p>
			</div>
		</div>
		<div id="reg_loan" class="modal">
			<div class="modal-content">
			</div>
		</div>
		<div id="edit_modal" class="modal">
			<div class="modal-content">
			<div class="row">
				<div class="input-field col s12">
					<input id="name" v-model="current_item.name"/>
					<label for="name" class="active">Navn</label>
				</div>
				<div class="input-field col s12">
					<input id="description" v-model="current_item.description"/>
					<label for="description" class="active">Beskrivelse</label>
				</div>
				<div class="input-field col s12">
					<input id="quantity" v-model="current_item.quantity"/>
					<label for="quantity" class="active">Kvantitet</label>
				</div>
				<div class="input-field col s12">
					<input id="thumbnail" v-model="current_item.thumbnail"/>
					<label for="thumbnail" class="active">Bilde</label>
				</div>
				<div class="input-field col s12">
					<select v-model="current_item.tags" v-if="current_item.tags" multiple>
						<option value="" disabled>Velg ny kategori</option>
						<option v-for="tag in tagList" :value="tag.id"> [[ tag.name ]] </option>
					</select>
				</div>
				<div class="input-field col s12">
					<input id="zone" v-model="current_item.zone"/>
					<label for="zone" class="active">Sone</label>
				</div>
				<div class="input-field col s12">
					<input id="shelf" v-model="current_item.shelf"/>
					<label for="shelf" class="active">Hylleplass</label>
				</div>
				<div class="input-field col s12">
					<input id="column" v-model="current_item.column"/>
					<label for="column" class="active">Kolonne</label>
				</div>
				<div class="input-field col s12">
					<button class="btn btn-large" v-on:click="postItem(current_item)" value="Oppdater"/>
				</div>
			</div>
			</div>
		</div>
		<div id="adm_loan" class="modal">
			<!-- add modal from administrate_loan.html -->
		</div>
		<div class="divider"></div>
	</div>
	<!-- End admin menu-->
	{% endif %}
	<div class="section white">
		<div class="container">
			<!-- start main content -->
			<div class="row">
				{% if perms.inventory %}
				<div class="col s6">
				</div>
				{% endif %}
				<!-- TODO: knytte søkefelt til items -->
				<div class="col s6">
					<input type="text" name="search" placeholder="Søk">
				</div>
			</div>
			<div class="row">
				<!-- Rabperry Pi category skeleton-->
				<div class="col s12">
					<ul class="collapsible">
						<li v-for="tag in tagList" :key="tag.id">
							<div class="collapsible-header">
								<span> [[ tag.name ]] </span>
							</div>
							<div class="collapsible-body" >
								<ul class="collection">
									<li v-for="item in tag.item_set" class="collection-item avatar">
										<img v-if="item.thumbnail" :src="item.thumbnail.file" alt="" class="circle">
										<a class="modal-trigger" v-on:click="getItem(item)" href="#edit_modal">
											<span class="title"> [[ item.name ]] </span>
										</a>
										<p>[[ item.description ]]<br>
										[[ item.quantity ]] stk, sone [[ item.zone ]], [[ item.shelf ]] [[ item.row ]] [[ item.column ]].
										</p>
										<a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
									</li>
								</ul>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>}
<script type="text/javascript">
	function readCookie(name) {
		var nameEQ = name + "=";
		var ca = document.cookie.split(';');
		for(var i=0;i < ca.length;i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') c = c.substring(1,c.length);
			if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
		}
		return null;
	}
	var csrftoken = readCookie('csrftoken');

	console.log("CSRF TOKEN SHOULD BE " + csrftoken);
	new Vue({
		el: "#app",
		delimiters: ["[[","]]"],
		data: {
			itemList: [],
			tagList: [],
			current_item: "",
			current_item_form: "",
		},
		mounted: function() {
			this.getItemList();
			this.getTagList();
		},
		methods: {
			getTagList: function() {
				this.$http.get('/inventory/tags').then((response => {
					this.tagList = response.data;
					console.log(response.data);
				}));
				console.log(this.itemList);
			},
			getItemList: function() {
				this.$http.get('/inventory/items').then((response => {
					this.itemList = response.data;
					console.log(response.data);
				}));
				console.log(this.itemList);
			},
			getItem: function(item) {
				this.current_item = item;
				var elem = document.querySelector('select');
				var instance = M.FormSelect.init(elem);

			},
			postItem: function(current_item) {
				this.$http.put('/inventory/items/' + current_item.id, current_item).then((response => {
					M.toast({html: response.statusText});
				}));
				this.getItemList();
				this.getTagList();
			},
		}
	});
	Vue.http.headers.common['X-CSRFTOKEN'] = csrftoken;
	M.AutoInit();
	
</script>

{% endblock content %}
